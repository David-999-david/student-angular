@defer (on viewport){ @if (vm$ | async; as v) {
<div class="px-3 py-4">
  @if (v.e){
  <div>
    <form
      [formGroup]="form"
      (ngSubmit)="save()"
      class="max-w-md sm:max-w-lg w-full mx-auto rounded-lg px-7 py-5 shadow mt-2 bg-white space-y-4"
    >
      <p class="font-semibold text-lg">Edit Course</p>
      <div class="flex flex-col space-y-2">
        <label for="name" class="text-sm font-medium">Name</label>
        <input
          formControlName="name"
          placeholder="Course name"
          class="border border-gray-300 rounded outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 px-2 py-1 placeholder:text-gray-400 text-sm"
        />
      </div>
      <div class="flex flex-col space-y-2">
        <label for="description" class="text-sm font-medium">Name</label>
        <textarea
          id="description"
          formControlName="description"
          placeholder="Description..."
          rows="4"
          class="border border-gray-300 rounded outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 px-2 py-1 placeholder:text-gray-400 text-sm"
        ></textarea>
      </div>
      <div class="flex flex-col sm:flex-row sm:justify-between space-y-5">
        <div class="space-y-1">
          <div class="grid grid-cols-[140px_1fr] items-center">
            <label for="status" class="text-sm font-medium">Status</label>
            <select
              id="status"
              formControlName="status"
              class="border rounded px-1 text-sm py-1 border-gray-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none"
            >
              <option [ngValue]="true">Active</option>
              <option [ngValue]="false">Inactive</option>
            </select>
          </div>
        </div>
        <div class="space-y-1">
          <div class="grid grid-cols-[140px_1fr] sm:grid-cols-[70px_1fr] sm:px-6 items-center">
            <label for="limit" class="text-sm font-medium">Limit</label>
            <input
              id="limit"
              formControlName="limit"
              placeholder="Student-limit"
              class="border placeholder:text-gray-400 rounded w-full sm:w-[140px] px-2 text-sm pb-1 border-gray-300 outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 py-1 active:border-blue-500"
            />
          </div>
          <div class="sm:pl-6">
            @if (c.limit.touched && c.limit.invalid) {
            <small class="block text-red-600 text-sm">
              @if (c.limit.errors?.['required']) {Limit is required} @if (c.limit.errors?.['min'])
              {Limit must be at least 5}
            </small>
            } @if (form.hasError('limitError')){
            <small class="block text-red-600"> Changes limit must be greater than current </small>
            }
          </div>
        </div>
      </div>
      <div class="flex flex-col space-y-5">
        <div class="space-y-1">
          <div class="grid grid-cols-[140px_1fr] items-center">
            <label for="start_date" class="text-sm font-medium">Start Date</label>
            <input
              id="start_date"
              formControlName="start_date"
              class="border rounded w-fit px-2 text-sm pb-1 border-gray-300 outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 py-1 active:border-blue-500"
              type="datetime-local"
              step="1"
            />
          </div>
          @if (c.start_date.touched && c.start_date.invalid) {
          <small class="block text-red-600">
            @if (c.start_date.errors?.['required']) {Start Date is required}
          </small>
          }
        </div>
        <div class="space-y-1">
          <div class="grid grid-cols-[140px_1fr] items-center">
            <label for="end_date" class="text-sm font-medium">End Date</label>
            <input
              id="end_date"
              formControlName="end_date"
              class="border rounded w-fit px-2 text-sm pb-1 border-gray-300 outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 py-1 active:border-blue-500"
              type="datetime-local"
              step="1"
            />
          </div>
          @if (c.end_date.touched && c.end_date.invalid) {
          <small class="block text-red-600">
            @if (c.end_date.errors?.['required']) {End Date is required}
          </small>
          } @if (form.hasError('dateOrder')) {
          <small class="block text-red-600"> End Date must after Start Date </small>
          }
        </div>
      </div>
      <div class="flex justify-start gap-2">
        <button
          [disabled]="saving()"
          type="submit"
          class="border rounded px-2 text-sm pb-0.5 bg-green-300 border-none shadow hover:bg-green-400 hover:text-white"
        >
          @if (saving()) {Saving} @if (!saving()) {Save}
        </button>
        <button
          [disabled]="saving()"
          type="button"
          (click)="cancel()"
          class="text-sm block border px-1 py-0.5 rounded bg-gray-400 hover:bg-gray-500 text-white"
        >
          Cancel
        </button>
      </div>
    </form>
  </div>
  } @else {
  <div
    class="flex flex-col space-y-4 shadow bg-[#FBFBFB] w-full max-w-full sm:w-auto mx-auto sm:max-w-xl rounded px-5 py-3"
  >
    <!-- [ngClass]="v.j ? ['sticky', 'top-5', 'z-30'] : []" -->
    <div class="flex justify-between items-center">
      <span
        class="text-sm border border-none shadow rounded px-2 py-0.5"
        [class.bg-green-300]="v.c.status"
        [class.bg-red-200]="!v.c.status"
      >
        {{ v.c.status ? 'Active' : 'Inactive' }}
      </span>
      <div class="flex items-center gap-x-4">
        @if (flash() && flash() !== 'Limit reach!') {
        <p
          class="text-sm border border-none shadow rounded bg-green-200 px-2 py-0.5"
          [ngClass]="{
            'bg-red-400': flash() === 'Status is Inactive',
            'text-white': flash() === 'Status is Inactive'
          }"
        >
          {{ flash() }}
        </p>
        }
        <button
          class="inline-flex justify-center items-center bg-green-200 rounded text-[16px] cursor-pointer hover:scale-110 px-0.5 py-0.5"
          (click)="onClick()"
        >
          <ng-icon name="heroPencilSquare"></ng-icon>
        </button>
        @if (v.j) {
        <button
          class="inline-flex justify-center item-center bg-green-200 text-[16px] rounded cursor-pointer hover:scale-110 px-0.5 py-0.5"
          (click)="cancelJoin()"
        >
          <ng-icon name="heroArrowUturnLeft"></ng-icon>
        </button>
        } @else {
        <button
          class="inline-flex justify-center item-center bg-green-200 text-[16px] rounded cursor-pointer hover:scale-110 px-0.5 py-0.5"
          (click)="makeJoin()"
        >
          <ng-icon name="heroUserPlus"></ng-icon>
        </button>
        }
      </div>
    </div>
    <div class="flex items-center justify-between w-full">
      <div class="grid grid-cols-[110px_1fr]">
        <span class="text-sm font-medium">Name:</span>
        <p class="text-sm">
          {{ v.c.name.toUpperCase() }}
        </p>
      </div>
      <div class="ml-10 border border-none rounded bg-green-100 px-2">
        <span class="text-lg font-medium">{{ v.c.current }}/</span>
        <span class="text-sm">{{ v.c.limit }}</span>
      </div>
    </div>
    <div class="grid grid-cols-[110px_1fr]">
      <span class="text-sm font-medium">Description:</span>
      <p class="text-sm">
        {{ v.c.description }}
      </p>
    </div>
    <div class="flex flex-col sm:flex-row w-full">
      <div class="grid grid-cols-[110px_1fr] w-1/2 sm:pr-10">
        <span class="text-sm font-medium">Start Date:</span>
        <p class="text-sm">
          {{ v.c.start_date }}
        </p>
      </div>
      <div class="grid grid-cols-[110px_1fr] w-1/2 sm:pl-10">
        <span class="text-sm font-medium">End Date:</span>
        <p class="text-sm">
          {{ v.c.end_date }}
        </p>
      </div>
    </div>
  </div>
  } @if (v.j) { @if (joinSIds().size > 0) {
  <div class="sticky top-2 sm:top-2 z-30 rounded border border-none bg-white px-3 py-1 mt-4 mb-4">
    <div class="flex justify-between mt-3 text-sm">
      <div class="flex gap-6">
        <button
          class="border border-none rounded px-2 py-0.5 bg-red-200 hover:bg-red-300 cursor-pointer"
          (click)="removeAll()"
        >
          Clear All
        </button>
        @if (flash() && flash() === 'Limit reach!') {
        <p
          class="text-sm text-center border border-none shadow rounded bg-green-200 px-2 py-0.5 bg-red-400 text-white"
        >
          {{ flash() }}
        </p>
        }
      </div>
      <div class="flex gap-6">
        <div class="
        border border-none rounded px-2 shadow
        ">
          <span
          class="text-lg font-medium"
          >{{ v.c.current + joinSIds().size }}</span>
          <span>/{{ v.c.limit }}</span>
        </div>
        <button
          class="border border-none rounded px-2 py-0.5 bg-blue-200 hover:bg-blue-400 cursor-pointer"
          (click)="joinS()"
        >
          {{ joining() ? 'Joining...' : 'Join' }}
        </button>
      </div>
    </div>
    <div class="flex flex-wrap gap-5 mt-4 mb-4">
      @for (s of joinSList(); track s.id) {
      <button
        class="flex items-center text-sm bg-zinc-300 rounded px-2 py-1 cursor-pointer"
        (click)="onJoin(s)"
      >
        {{ s.name }}
        <ng-icon name="heroXMark" class="mt-0.5" color="black"></ng-icon>
      </button>
      }
    </div>
  </div>
  }
  <div class="flex justify-between mt-4">
    <input
      type="search"
      (keydown.enter)="onEnter()"
      placeholder="Search By Name"
      class="placeholder:text-gray-400 bg-white border border-black outline-none focus:border-blue-500 text-sm px-2 py-1 rounded mr-2"
      [formControl]="search"
    />
    <div class="flex">
      <button
        class="text-sm px-1 rounded border-none shadow border bg-white hover:bg-gray-200 cursor-pointer mr-6"
        [disabled]="v.q.p == 1"
        (click)="prevPage(v.q.p)"
      >
        Prev
      </button>
      @for (p of range(v.f.m.totalPages); track p) {
      <button
        class="text-[#FF9A00] px-2 cursor-pointer text-sm ml-2 mr-2"
        [class.bg-white]="p == v.q.p"
        [class.rounded]="p == v.q.p"
        [class.bg-blue-200]="p == v.q.p"
        (click)="goToPage(p)"
      >
        {{ p }}
      </button>
      }
      <button
        class="text-sm px-1 rounded border-none shadow border bg-white hover:bg-gray-200 ml-2 mr-1 cursor-pointer"
        [disabled]="v.q.p == v.f.m.totalPages"
        (click)="nextPage(v.q.p)"
      >
        Next
      </button>
    </div>
  </div>
  @if (filteredStudents.length === 0) {
  <p class="text-sm text-white text-center mt-20">Not found</p>
  } @else {
  <div class="flex justify-between mb-2 ml-1 mt-1"></div>
  <div class="pb-5 px-1">
    <div class="relative overflow-x-auto border border-gray-300 shadow mx-auto rounded">
      <table class="table-auto min-w-full">
        <thead class="bg-gray-200">
          <tr class="text-left text-sm">
            <th class="px-3">No.</th>
            <th class="px-3 py-1.5">Name</th>
            <th class="px-3">Eamil</th>
            <th class="px-3">Phone</th>
            <th class="px-3">Address</th>
            <th class="px-3">Gender</th>
            <th class="px-3">Status</th>
            <th class="px-3">Courses</th>
          </tr>
        </thead>
        <tbody class="divide-y">
          @for (st of filteredStudents; track st.id ; let i = $index){
          <tr
            class="text-sm cursor-pointer"
            (click)="onJoin(st)"
            [ngClass]="{
              'bg-blue-200': isSelected(st.id),
              'odd:bg-white': !isSelected(st.id),
              'even:bg-gray-100': !isSelected(st.id)
            }"
            [class.bg-blue-200]="isSelected(st.id)"
          >
            <td class="px-3 w-24">{{ i + 1 }}</td>
            <td class="px-3 py-2 w-40">{{ st.name }}</td>
            <td class="px-3 w-40">{{ st.email }}</td>
            <td class="px-3 w-48px">{{ st.phone }}</td>
            <td class="px-3 w-fit">{{ st.address }}</td>
            <td class="px-3 w-24">{{ st.gender }}</td>
            <td
              class="px-3 w-[40px]"
              [class.bg-green-100]="st.status"
              [class.text-green-700]="st.status"
              [class.bg-red-100]="!st.status"
              [class.text-gray-700]="!st.status"
            >
              {{ st.status ? 'Active' : 'Inactive' }}
            </td>
            <td class="px-3 w-40">{{ st.courses.length }}</td>
          </tr>
          }
        </tbody>
      </table>
    </div>
  </div>
  } } @else { @if (v.c.students.length === 0) {
  <p class="text-center text-sm text-white font-medium mt-30">There is no students</p>
  } @else {
  <div
    class="relative overflow-x-auto border border-none rounded mt-5 bg-[#FBFBFB] border-gray-300 shadow"
  >
    <table class="table-auto min-w-full">
      <thead class="text-sm font-medium text-left">
        <tr class="bg-gray-300">
          <th class="px-3 py-1">No.</th>
          <th class="px-3">Name</th>
          <th class="px-3">Email</th>
          <th class="px-3">Phone</th>
          <th class="px-3">Address</th>
          <th class="px-3">Status</th>
          <th class="px-3">Gender</th>
          <td></td>
        </tr>
      </thead>
      <tbody class="divide-y">
        @for (s of v.c.students; track s.id; let i = $index) {
        <tr class="text-sm odd:bg-white even:bg-gray-100">
          <td class="px-3 py-1">{{ i + 1 }}</td>
          <td class="px-3">{{ s.name }}</td>
          <td class="px-3">{{ s.email }}</td>
          <td class="px-3">{{ s.phone }}</td>
          <td class="px-3">{{ s.address }}</td>
          <td
            class="px-3"
            [class.bg-green-100]="s.status"
            [class.text-700]="s.status"
            [class.bg-red-100]="!s.status"
            [class.text-gray-700]="!s.status"
          >
            {{ s.status ? 'Active' : 'Inactive' }}
          </td>
          <td class="px-3">{{ s.gender }}</td>
          <td class="px-3 text-center">
            @if(deleteId() === s.id){
            <ng-icon name="heroArrowPath"></ng-icon>
            } @else {
            <button
              class="inline-flex justify-center items-center px-1 py-0.5 border border-none rounded bg-red-300 text-white cursor-pointer hover:bg-red-400 hover:scale-110"
              (click)="cancelJoinD(s.id); $event.stopPropagation(); $event.preventDefault()"
            >
              <ng-icon name="heroMinus"></ng-icon>
            </button>
            }
          </td>
        </tr>
        }
      </tbody>
    </table>
  </div>
  } }
</div>
} @else {
<p>Failed to Load Course detail</p>
} } @placeholder {
<p>Loading...</p>
} @loading {
<p>Loading...</p>
} @error {
<p>Couldn't load course detail</p>
}
